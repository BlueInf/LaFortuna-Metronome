#include <stdint.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include <math.h>
//#include "lcd.h"
#include <ruota.h>
#include <util/delay.h>
#include "image.h"

#define STEP_DELAY_MS 5
#define MIN_STEP    2    /* > 0 */
#define MAX_STEP  255
#define HEIGHT LCDWIDTH
#define WIDTH  LCDHEIGHT

#define TITLE_FRAME 0

int screen_state;

void titleFrame();
void init(void);

int8_t enc_delta(void);
volatile int8_t delta;

int displayFrame(int state);

volatile flag=0;
volatile counter=0;

int displayFrame(int state){
    counter++;
    flag=1;
    return state;
}

int main(void) {
    // uint8_t cnt = MAX_STEP/2;
	// uint8_t i;
	// int16_t res;


    init();
    //cli();
    os_add_task(displayFrame,      25, 1);
   // sei();

    sei();
    for(;;){


    screen_state=TITLE_FRAME;
    switch (screen_state)
    {
        
    
     cli();
     sei();
        case TITLE_FRAME:
            titleFrame();
            break;
    
        default:
            titleFrame();
            break;
    }
    
}
}


/* Configure I/O Ports */
void init(void) {

    /* 8MHz clock, no prescaling (DS, p. 48) */
    CLKPR = (1 << CLKPCE);
    CLKPR = 0;


    /** Initialize the  display */
    init_lcd();

    /** show the title frame */
    //titleFrame();

 //   os_init_scheduler();
    os_init_ruota();

 
}



// -----------------------------------------------------------------------------
// --------------------------------Frames---------------------------------------
// -----------------------------------------------------------------------------





const uint16_t sinewave[]= //sine 256 values
{
	0x80,0x83,0x86,0x89,0x8c,0x8f,0x92,0x95,0x98,0x9c,0x9f,0xa2,0xa5,0xa8,0xab,0xae,
	0xb0,0xb3,0xb6,0xb9,0xbc,0xbf,0xc1,0xc4,0xc7,0xc9,0xcc,0xce,0xd1,0xd3,0xd5,0xd8,
	0xda,0xdc,0xde,0xe0,0xe2,0xe4,0xe6,0xe8,0xea,0xec,0xed,0xef,0xf0,0xf2,0xf3,0xf5,
	0xf6,0xf7,0xf8,0xf9,0xfa,0xfb,0xfc,0xfc,0xfd,0xfe,0xfe,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0xfe,0xfd,0xfc,0xfc,0xfb,0xfa,0xf9,0xf8,0xf7,
	0xf6,0xf5,0xf3,0xf2,0xf0,0xef,0xed,0xec,0xea,0xe8,0xe6,0xe4,0xe2,0xe0,0xde,0xdc,
	0xda,0xd8,0xd5,0xd3,0xd1,0xce,0xcc,0xc9,0xc7,0xc4,0xc1,0xbf,0xbc,0xb9,0xb6,0xb3,
	0xb0,0xae,0xab,0xa8,0xa5,0xa2,0x9f,0x9c,0x98,0x95,0x92,0x8f,0x8c,0x89,0x86,0x83,
	0x80,0x7c,0x79,0x76,0x73,0x70,0x6d,0x6a,0x67,0x63,0x60,0x5d,0x5a,0x57,0x54,0x51,
	0x4f,0x4c,0x49,0x46,0x43,0x40,0x3e,0x3b,0x38,0x36,0x33,0x31,0x2e,0x2c,0x2a,0x27,
	0x25,0x23,0x21,0x1f,0x1d,0x1b,0x19,0x17,0x15,0x13,0x12,0x10,0x0f,0x0d,0x0c,0x0a,
	0x09,0x08,0x07,0x06,0x05,0x04,0x03,0x03,0x02,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x02,0x03,0x03,0x04,0x05,0x06,0x07,0x08,
	0x09,0x0a,0x0c,0x0d,0x0f,0x10,0x12,0x13,0x15,0x17,0x19,0x1b,0x1d,0x1f,0x21,0x23,
	0x25,0x27,0x2a,0x2c,0x2e,0x31,0x33,0x36,0x38,0x3b,0x3e,0x40,0x43,0x46,0x49,0x4c,
	0x4f,0x51,0x54,0x57,0x5a,0x5d,0x60,0x63,0x67,0x6a,0x6d,0x70,0x73,0x76,0x79,0x7c
};


int firstTitle=1;
void titleFrame(){
    if(!(get_switch_state(_BV(SWN)) || get_switch_state(_BV(SWE)) || get_switch_state(_BV(SWW)) || get_switch_state(_BV(SWS))) && firstTitle){
    firstTitle=0;
    clear_screen();
    display_string_xy("This is the metronome!!!!",WIDTH/3-30,HEIGHT/2);
    display_string_xy("Double tap to set the frequency",WIDTH/3-30,HEIGHT/2+8);
    display_string_xy("Made by Krasimir Marinov",WIDTH/3-30,HEIGHT/2+16);
    } else if(get_switch_state(_BV(SWN)) || get_switch_state(_BV(SWE)) || get_switch_state(_BV(SWW)) || get_switch_state(_BV(SWS)) && firstTitle==0 ){
        display_string_xy("Up button clicked",WIDTH/3-30,HEIGHT/2+24);




    }

    

    // double midHeight=HEIGHT/2;
    // double midWidth=WIDTH/2;
    // image sinWaveImg;
    // sinWaveImg.left=50;
    // sinWaveImg.top=;
    // sinWaveImg.height=100;
    // sinWaveImg.width=100;
    // sinWaveImg.colour=WHITE;

    // draw_image_indexed(sinWaveImg,logo_map);
    
}


void upFrame(){
    clear_screen();
    display_string("This is the up Frame!!!!\n");
}

